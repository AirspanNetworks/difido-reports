<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="description" content="Kibana frame">
	<meta name="author" content="Itai Agmon">
	<title>Kibana</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<style>
		body {
			margin: 0;
		}
		
		#kibana {
			overflow: hidden;
			overflow-x: hidden;
			overflow-y: hidden;
			height: 100%;
			width: 100%;
			position: absolute;
			top: 51px;
			left: 0px;
			right: 0px;
			bottom: 0px;
			border: 0px;
		}
	</style>
</head>

<body style="margin:0px;padding:0px;overflow:hidden">
	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand" href="index.html">Difido</a>
			</div>
			<ul class="nav navbar-nav">
				<li><a href="index.html">Execution Reports</a></li>
				<li class="active"><a href="#">Kibana</a></li>
			</ul>
		</div>
	</nav>
	<iframe id="kibana" src="#"></iframe>

	<script type="text/javascript" src="js/jquery-1.12.0.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/bootbox.js"></script>
	<script>

		function getKeysFromAggregrasionResponse(response) {
			var buckets = response.aggregations.field_value.buckets;
			var result = [];
			buckets.forEach(function(bucket){
				result.push(bucket.key);				
			});
			return result;

		}

		function getElasticUrl(){
			return new Promise(function (fulfill, reject){
				$.ajax({
					url : '/api/settings',
					type : 'GET',
						}).done(function(settings) {
								var regex = /kibana.url:(.+)/;
								var kibanaUrl = regex.exec(settings)[1].trim();
								fulfill(kibanaUrl);
						});

			});

		}

		function getElasticFields(){
			return new Promise(function (fulfill, reject){
				$.ajax({
					url : '/api/settings',
					type : 'GET',
						}).done(function(settings) {
								var regex = /kibana.fields:(.+)/;
								var fields = regex.exec(settings)[1].trim().split(";");
								fulfill(fields);
						});

			});

		}

		function getAggregatedTermsFromElastic(index, document, term) {
			return new Promise(function (fulfill, reject){
				url = "/api/elastic/" + index + "/" + document;
				$.ajax({
					contentType: 'application/json',
					url : url,
					type: "POST",
					data: '{  "aggs": {"field_value": {"terms": { "field": "' + term +'", "size": 0 } } } }'
				}).done(function(response){
					fulfill(getKeysFromAggregrasionResponse(response));
				});

			});

		}

		function displayForm(kibanaUrl,dashboards,fieldNames, fieldValues) {
			var dashboardOptions = "";
			dashboards.forEach(function(dashboard){
					dashboardOptions += '<option>' + dashboard +'</option>';

			});
			var fieldSections = "";
			for (var i = 0 ; i < fieldNames.length ; i++) {
				if (!fieldValues[i] || fieldValues[i].length == 0){
					continue;
				}
				fieldSections += createFieldSection("field" + i,fieldNames[i],fieldValues[i])

			}
			bootbox.dialog({
					title: "Dashboard Parameters",
					message:'   <form class="form-horizontal">' +
							'       <div class="form-group">' +
							'           <div class="form-group">' +
							'               <label class="col-md-4 control-label" for="name">Dashboard</label>' +
							'               <div class="col-md-4">' +
							'                   <select id="dashboard" name="dashboard" class="form-control">' + dashboardOptions +
							'                   </select>' +
							'               </div>' +
							'           </div>' +
							'           <div class="form-group">' +
							'               <label class="col-md-4 control-label" for="name">Time Range</label>' +
							'               <div class="col-md-4">' +
							'                   <select id="range" name="range" class="form-control">' +
							'                   	<option>now-15m</option>' +
							'                   	<option>now-30m</option>' +
							'                   	<option>now-12h</option>' +
							'                   	<option>now-7d</option>' +
							'                   	<option selected="selected">now-30d</option>' +   
							'                   	<option>now-1y</option>' +
							'                   </select>' +
							'               </div>' +
							'           </div>' + 
									 fieldSections +
							'       </div>' +
							'   </form>',
					buttons: {
							success: {
									label: "Execute",
									className: "btn-success",
									callback: function () {										
										var query = "";										
										for (var i = 0; i < fieldNames.length ; i++) {
											if (i != 0){
												query += " AND ";											
											}
											query += fieldNames[i] + ":" + $('#field' + i +'').val();
										}
										var range = $('#range').val();
										$.ajax({
												url : '/api/settings',
												type : 'GET',
										}).done(function(settings) {
												document.getElementById('kibana').src = kibanaUrl + "/app/kibana?#/dashboard/" + $('#dashboard').val() + "?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:" + range + ",mode:quick,to:now))&_a=(filters:!(),options:(darkTheme:!f),query:(query_string:(analyze_wildcard:!t,query:'" + query + "')),title:main,uiState:())";
										});



										}
									}
							}
					}
				);
		}

		function createFieldSection(id,field, values) {
			var options = "";
			values.forEach(function(value){
					options += '<option>' + value +'</option>';

			});
			return '<div class="form-group">' +
				'   	<label class="col-md-4 control-label" for="'+ field +'">'+ field +'</label>' +
				'       	<div class="col-md-4">' +
				'           	<select id="'+ id +'" name="'+ id +'" placeholder="'+ field +'" class="form-control input-md">' +
				                options +
				'               </select>' +
				'           </div>' +
				'   </div>';

		}

		$(document).ready(function() {
			console.log("CALLED");
			getAggregatedTermsFromElastic(".kibana","dashboard","title")
				.then(function(dashboards){
					getElasticUrl()
						.then(function(kibanaUrl) {
							getElasticFields()
								.then(function(fieldNames) {
									var fieldsSection = "";
									promises = [];
									fieldNames.forEach(function(fieldName){
										promises.push(getAggregatedTermsFromElastic("report","test",fieldName));
									});
									Promise.all(promises).then(fieldValues => {
										displayForm(kibanaUrl,dashboards,fieldNames,fieldValues);
									});

								});
						});
				});
		});

	</script>

</body>

</html>