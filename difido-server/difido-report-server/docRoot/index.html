<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Main view of the Difido report server">
        <meta name="author" content="Itai Agmon">

        <title>List of Reports</title>

        <!-- Bootstrap core CSS -->
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/jquery-ui-1.8.4.custom.css" rel="stylesheet">
        <link href="css/jquery.dataTables_themeroller.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
          <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="container-fluid">
            <!--<div class="row">-->
            <div class="col-sm-2 hidden-sm hidden-xs">
            </div>
            <div class="col-sm-8 main" >
                <table id="reports">
                    <thead>
                        <tr id="table_header">
	                		<th id='id'>Id</th>
	                		<th id='execution'>Execution</th>
                        	<th id='date'>Date</th>
	                		<th id='time'>Time</th>
	                		<th id='tests'># Tests</th>
	                		<th id='success'># Success</th>
	                		<th id='warning'># Warning</th>
	                		<th id='fails'># Fails</th> 		
	                		<th id='machines'># Machines</th>
	                		<th id='active'>Active</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <button type="button" onclick="restartExecution()" >Restart Execution</button>
			<button type="button" onclick="deleteExecutions()" >Delete Executions</button>
            <div class="col-sm-2 hidden-sm hidden-xs">
            </div>

        </div>
        <!--</div>-->

        <!-- Bootstrap core JavaScript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="js/jquery.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script type="text/javascript" src="js/jquery.dataTables.js"></script> 
        <script>
			function deleteExecutions(){
				$.ajax({
					url: 'api/reports',
					type: 'DELETE',
					success: function() {
						alert("All reports have been deleted");
						location.reload();
					}
				});
			}
		
        	function restartExecution(){
        		$.post('api/executions', function(index){
        			alert("Execution has been restarted. Execution index is now: "+index)
        			location.reload();
        		});
        	}
        
        	function convertToDataTable(){
        	    $('#reports').dataTable({
                    "bJQueryUI": true,
                    "sPaginationType": "full_numbers",
					"iDisplayLength": 25
                });
        		
        	}
        	
        	/**
			 * Create appropriate headers for all the customized execution
			 * properties
			 */
        	function addCustomedHeaders(reports,table){
        		 $(reports).each(function(){
 			    	if (this.properties != null){
			    		for(var key in this.properties) {
			    		    var value = this.properties[key];
			    		    if ( $(".custom_header[custom='"+ key+ "']").length == 0 ) {
			    		    	// We will use the 'custom" attribute, later on
								// for populating the table at the right
								// location
			    		    	$('#table_header').append($('<th>').text(key).attr('custom',key).addClass("custom_header"));
			    		    }
			    		}
			    	}
        			 
        		 });
        	}
        	
	        function appendReportsToTable(reports,table){
			    $(reports).each(function(){
			    	var tr = $('<tr>');
			    	tr.append($('<td>').text(this.id));
			    	var executionName = this.folderName;
			    	if (this.description != null && this.description != ""){
			    		executionName = this.description
			    	}
			    	tr.append($('<td>').append($('<a>').text(executionName).attr("href",this.uri).attr("target","_blank")));
			    	tr.append($('<td>').text(this.date));
			    	tr.append($('<td>').text(this.time));
			    	tr.append($('<td>').text(this.numOfTests));
			    	tr.append($('<td>').text(this.numOfSuccessfulTests));
			    	tr.append($('<td>').text(this.numOfTestsWithWarnings));
			    	tr.append($('<td>').text(this.numOfFailedTests));
			    	tr.append($('<td>').text(this.numOfMachines));
			    	tr.append($('<td>').text(this.active));
			    	
			    	// Since we don't know which of the customized columns exist
					// in this execution. We just add blank td. This is
					// important since if we will fail to do this, the data
					// table will fail to render.
			    	for (i = 0 ; i < $(".custom_header").size() ; i++){
			    		tr.append($('<td>').text(""));
			    	}
			    	
			    	// We now populate the customized properties.
			    	if (this.properties != null){
			    		for(var key in this.properties) {
			    		    var value = this.properties[key];
			    		    
			    		    // We get the exact index of the header
			    		    var index = $(".custom_header[custom='"+key+"']").index();
			    		    if (index < 0){
			    		    	// Something went wrong. We don't have a header
								// that matches this property
			    		    	continue;
			    		    }
			    		    
			    		    // We now add the text in the correct index
			    		    tr.children()[index].innerHTML = value;
			    		}
			    	}
			    	
			    	$(table).append(tr);
			    });
	        }
        
            function createTable() {
                $.get("/api/reports", function(reports){
                	addCustomedHeaders(reports,$("#reports"));
                    appendReportsToTable(reports,$("#reports"));
                    convertToDataTable();
                });
            }

            $(document).ready(function() {
                createTable();
            });
            
        </script>
    </body>
</html>
